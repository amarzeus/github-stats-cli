<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Stats - {{ username }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">GitHub Stats CLI</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/compare">Compare</a>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1>GitHub Stats for {{ username }}</h1>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadStats('json')">JSON</button>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadStats('yaml')">YAML</button>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadStats('csv')">CSV</button>
                    </div>
                </div>

                <div id="loading" class="text-center my-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading GitHub statistics...</p>
                </div>

                <div id="stats" class="d-none">
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title" id="followers">-</h5>
                                    <p class="card-text">Followers</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title" id="following">-</h5>
                                    <p class="card-text">Following</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title" id="repos">-</h5>
                                    <p class="card-text">Public Repos</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title" id="gists">-</h5>
                                    <p class="card-text">Public Gists</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Profile Information</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Name:</strong> <span id="name">-</span></p>
                            <p><strong>Bio:</strong> <span id="bio">-</span></p>
                            <p><strong>Location:</strong> <span id="location">-</span></p>
                            <p><strong>Account Created:</strong> <span id="created">-</span></p>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Top Repositories</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="reposTable">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Stars</th>
                                            <th>Language</th>
                                            <th>Forks</th>
                                            <th>Open Issues</th>
                                            <th>Last Updated</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reposBody">
                                        <tr>
                                            <td colspan="6" class="text-center">Loading repositories...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Repository Language Distribution</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="languageChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let statsData = null;

        async function loadStats(format = 'json') {
            try {
                document.getElementById('loading').classList.remove('d-none');
                document.getElementById('stats').classList.add('d-none');

                const response = await fetch(`/api/stats/{{ username }}?format=${format}`);
                const data = format === 'json' ? await response.json() : await response.text();

                if (format === 'json') {
                    statsData = data;
                    displayStats(data);
                } else {
                    // Display raw data
                    document.getElementById('stats').innerHTML = `<pre>${data}</pre>`;
                    document.getElementById('stats').classList.remove('d-none');
                }

                document.getElementById('loading').classList.add('d-none');
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('loading').innerHTML = '<p class="text-danger">Error loading statistics. Please try again.</p>';
            }
        }

        function displayStats(data) {
            // Update stats cards
            document.getElementById('followers').textContent = data.followers || 0;
            document.getElementById('following').textContent = data.following || 0;
            document.getElementById('repos').textContent = data.public_repos || 0;
            document.getElementById('gists').textContent = data.public_gists || 0;

            // Update profile info
            document.getElementById('name').textContent = data.name || 'N/A';
            document.getElementById('bio').textContent = data.bio || 'N/A';
            document.getElementById('location').textContent = data.location || 'N/A';
            document.getElementById('created').textContent = data.created_at || 'N/A';

            // Update repositories table
            const reposBody = document.getElementById('reposBody');
            reposBody.innerHTML = '';

            if (data.top_repositories && data.top_repositories.length > 0) {
                data.top_repositories.forEach(repo => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><a href="https://github.com/{{ username }}/${repo.name}" target="_blank">${repo.name}</a></td>
                        <td>${repo.stars}</td>
                        <td>${repo.language || 'N/A'}</td>
                        <td>${repo.forks}</td>
                        <td>${repo.open_issues}</td>
                        <td>${new Date(repo.updated_at).toLocaleDateString()}</td>
                    `;
                    reposBody.appendChild(row);
                });

                // Create language chart
                createLanguageChart(data.top_repositories);
            } else {
                reposBody.innerHTML = '<tr><td colspan="6" class="text-center">No repositories found</td></tr>';
            }

            document.getElementById('stats').classList.remove('d-none');
        }

        function createLanguageChart(repos) {
            const languages = {};
            repos.forEach(repo => {
                const lang = repo.language || 'Others';
                languages[lang] = (languages[lang] || 0) + 1;
            });

            const ctx = document.getElementById('languageChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(languages),
                    datasets: [{
                        data: Object.values(languages),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Load stats on page load
        loadStats();
    </script>
</body>
</html>
